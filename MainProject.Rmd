---
title: "Main Project"
author: "Celina"
date: "10/28/2021"
output: html_document
---

```{r, include=FALSE}
# Necessary Packages 
rm(list=ls())
library(readr)
library(tidyverse)
library(dplyr)
library(stringr)
```


# Downloading the Data and joining  
```{r, message=FALSE, warning=FALSE}
#Demographic Data
demo_2019 <- read_csv("data\\WICounty2019Demographics.csv", skip = 1) %>%
  select(-matches("(Margin)|(Percent)|(ratio)|(_1)"), -id) %>%
  select(matches("(Total population)|(Geographic Area)")) %>%
  select(-matches("Hispanic or Latino \\(of any race\\)!!"), 
         -matches("American Indian and Alaska Native!!"),
         -matches("Asian!!"),
         -matches("Native Hawaiian and Other Pacific Islander!!"),
         -matches("Two or more races!"), 
         -matches("and over$"), 
         -matches("Race alone or in combination with one or more other races!!")) %>% 
  rename_all(funs(str_replace_all(., "((Estimate!!)|(Total population!!)+)", ""))) %>%
  rename(County = "Geographic Area Name") %>%
  mutate(County = sub(" County, Wisconsin", "", County))

#Income Data
income_2019 <- read_csv("data\\WICounty2019Income.csv", na = "N", skip=1) %>%
  select(-id,-matches("(Margin)|(Distribution)")) %>%
  select(-matches("race"), -matches("FAMILIES!!families!!")) %>%
  rename_all(funs(str_replace_all(., "((Estimate!!)|(Number!!))+", ""))) %>%
  rename(County = "Geographic Area Name")%>%
  mutate(County = sub(" County, Wisconsin", "", County))

#Library Data
library_data <- readxl::read_excel("data\\public_library_service_data_2019.xlsx", sheet = "2019 PRELIMINARY DATA", skip = 1) %>%
  slice(-1) %>%
  select(-c(
            "Library ID", 
            "Municipality",
            "Public Library System",
            "Branches", 
            "15. No. of Bookmobiles Owned", 
            "Other Service Outlets", 
            "Books-by-Mail", 
            "Joint Library under s.43.53 1=Yes", 
            "Participating Municipalities", 
            "Circulation Count Method: Actual / Survey", 
            "Locale Code", 
            "Other Material Description"), 
         -matches("(Outlay)|(Access Denied)|(Databases)|(Circulation)|(Collection Retrievals)")) 

data <- library_data %>%
  na_if("0") %>%
  left_join(demo_2019, by="County") %>%
  inner_join(income_2019, by="County") 

```


#### General Introduction: Understanding the data and where funding goes

________________________ **READ ME** ______________________________________

I've created three new datasets: 
1. `programs_staff` = Number of Programs and Staff per County 
2. `Library_income_costs` = Total Income and Costs for library (All Numbers here are in Dollars)  
3. `computer_usage_data` = All Computer Usage by county (column names explain more)

Notes for all three datasets: 
1. I've renamed all the columns to remove spaces so we don't have to use ` anymore and RStudio can autocomplete the variables  
2. I've dropped all the rows that contain missind data for each new dataset. We can add that back in later if we want but, for now they are dropped. 
3. All numbers in the new datasets are actual numbers and not character strings so you can use math functions on them. 


```{r}
 programs_staff <- data %>%
  select(County, matches("(Number .*Program)|(Staff)"), "Total Income") %>%
  drop_na() %>%
  rename_all(funs(str_replace_all(., " ", "_"))) %>%
  mutate(across(.cols=-c(County), as.numeric)) %>%
  group_by(County) %>%
  mutate(across(.cols=everything(), sum)) %>%
  unique() 


library_income_costs <- data %>%
  select(County, "Total Income", 
         "Salaries & Wages", 
         "Print Materials", 
         "Electronic format", 
         "Audiovisual Materials", 
         "Contracted Services", 
         "Other Operating Expenditures", 
         "Total Operating Expenditures", 
         "Resident Support per Capita (Local Revenues and Resident Population)") %>%
  rename(Library_Income = `Total Income`) %>%
  rename_all(funs(str_replace_all(., " ", "_"))) %>%
  rename(Resident_Support_per_Capita = `Resident_Support_per_Capita_(Local_Revenues_and_Resident_Population)`) %>%
  drop_na() %>%
  mutate(across(.cols=-c(County), as.numeric)) %>%
  group_by(County) %>%
  mutate(across(.cols=everything(), sum)) %>%
  unique()

# Note: Library focuses activies on Children (0-11), Young Adults (12-18), and other. 
# They only recorded the Number of Uses of computers, they didn't divide it based on if they had access to Wifi
# Not all locations record Wireless Uses or Library Visits but, I thought they could be useful. 

computer_Usage_Data <- data %>%
  select(County, 
         matches("SEX AND AGE"), 
         -matches("(Male)|(Female)|(Median)"), 
         "Median income (dollars)!!FAMILIES!!Families", 
         "Median income (dollars)!!NONFAMILY HOUSEHOLDS!!Nonfamily households", 
          matches("Computers"), "Wireless Internet Uses", 
         "Library Visits") %>%
  drop_na() %>%
  rename(Total_Population = "SEX AND AGE!!Total population", 
         Income_Familes = "Median income (dollars)!!FAMILIES!!Families", 
         Income_NonFamily = "Median income (dollars)!!NONFAMILY HOUSEHOLDS!!Nonfamily households") %>%
  rename_all(funs(str_replace_all(., "((SEX AND AGE!!)|( years))+", ""))) %>%
  rename_all(funs(str_replace_all(., " ", "_"))) %>%
  mutate(across(.cols=-c(County), as.numeric)) %>%
  group_by(County)  %>%
  mutate(across(.cols=everything(), sum), 
         Uses_per_Computer = Uses_of_Public_Internet_Computers/Number_of_Public_Use_Computers, 
         Uses_per_Computer_with_Internet = Uses_of_Public_Internet_Computers/Number_of_Public_Use_Computers_with_Internet_Access)%>%
  unique()
  
```



# Basic Graphs of Computer Usage with Income Levels 

```{r}
computer_usage_graph <- computer_Usage_Data %>%
  left_join(library_income_costs, by="County") %>%
  select("Total_Population", "Uses_per_Computer", "Library_Visits", "Income_Familes", "Wireless_Internet_Uses", "Income_NonFamily", "County") %>%
  pivot_longer(cols = c("Income_Familes", "Income_NonFamily"), names_to = "Income_Type", values_to = "Income")

computer_usage_graph %>%
  ggplot(aes(x = Income, y = Uses_per_Computer/Total_Population)) + 
  geom_point() + 
  labs(y = "Ratio of Library Computer Usage to County Population", x = "Income", title = "Relationship of County Wealth to Library Computer Usage") + 
  geom_smooth(method = lm, se=FALSE, color="red") + 
  facet_wrap(~Income_Type)

computer_usage_graph %>%
  ggplot(aes(x = Income, y = Library_Visits/Total_Population)) + 
  geom_point() + 
  labs(x = "Income", y = "Number of Library Visits", title = "Library Visits v. County Population") + 
  geom_smooth(method = lm, se=FALSE, color="red") + 
  facet_wrap(~Income_Type)

computer_usage_graph %>%
  ggplot(aes(x = Income, y = Wireless_Internet_Uses/Total_Population)) + 
  geom_point() + 
  labs(x = "Income", y = "Wireless Usage", title = "Wireless Usage v. County Population") + 
  geom_smooth(method = lm, se=FALSE, color="red") + 
  facet_wrap(~Income_Type)
```
```{r}
# Some outlining data points 

# Dane County Median Income is MUCH HIGHER than other places 
computer_Usage_Data %>% 
  select(matches("ncome")) %>%
  filter(Income_Familes > 1500000)

computer_usage_graph %>%
  filter(Wireless_Internet_Uses/Total_Population > 1)
```


```{r}
library_income_costs %>%
  select(-c(Library_Income, Total_Operating_Expenditures, Resident_Support_per_Capita)) %>%
  mutate(Materials = sum(Print_Materials, Electronic_format, Audiovisual_Materials)) %>%
  select(`Salaries_&_Wages`, Materials, Contracted_Services, Other_Operating_Expenditures, County) %>%
  mutate(Total = sum(`Salaries_&_Wages`, Materials, Contracted_Services, Other_Operating_Expenditures)) %>%
  summarise(`Salaries & Wages` = `Salaries_&_Wages`/Total, 
            Materials = Materials/Total, 
            Contracted_Services = Contracted_Services/Total, 
            Other = Other_Operating_Expenditures/Total) %>%
  
  pivot_longer(cols = matches("a")) %>%
  ggplot(aes(x = name, y = value)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+ 
  facet_wrap(~County)

# Most income primarily goes towards paying salaries. What's the average salary per person? 

programs_staff %>% 
  left_join(library_income_costs, by = "County") %>%
  select(County, Total_Staff, `Salaries_&_Wages`, Other_Paid_Staff) %>%
  drop_na() %>%
  summarise(Ave_Salary = `Salaries_&_Wages`/Total_Staff, 
            non_librarian = Other_Paid_Staff/Total_Staff) %>%
  arrange(Ave_Salary) %>%
  left_join(computer_Usage_Data, by = "County") %>%
  select(County, Ave_Salary, Income_Familes, non_librarian) %>%
  ggplot(aes(x = Income_Familes, y = Ave_Salary)) + 
  geom_point() + 
  labs(x = "Median Family Income", y = "Average Staff Salary", title = "Average Salary by County Wealth")

```















# Old code 


When I reformatted the data and removed the income by race column since there wasn't a lot of data about it. I think we could add it back in if we think it is necessary but, for now I'm just putting it in a separate section.  
I'm getting 3 counties instead of 8 but, this is probably why we were miscommunicating in groupMe.  


```{r, warning=FALSE, message=FALSE, echo=FALSE}
# demo_2019 <- read_csv("data\\WICounty2019Demographics.csv", skip = 1) %>%
#   select(-matches("(Margin)|(Percent)|(ratio)|(_1)"), -id) %>%
#   select(matches("(Total population)|(Geographic Area)")) %>%
#   rename_all(funs(str_replace_all(., "((Estimate!!)|(Total population!!)+)", ""))) %>%
#   rename(County = "Geographic Area Name") %>%
#   mutate(County = sub(" County, Wisconsin", "", County))
# 
# #Income Data
# income_2019 <- read_csv("data\\WICounty2019Income.csv", na = "N", skip=1) %>%
#   select(-id,-matches("(Margin)|(Distribution)|(FAMILY SIZE)")) %>%
#   rename_all(funs(str_replace_all(., "((Estimate!!)|(Number!!)|(FAMILIES!!)|(HOUSEHOLD INCOME BY AGE OF HOUSEHOLDER!!)|(NONFAMILY HOUSEHOLDS!!)|(HOUSEHOLD INCOME BY RACE AND HISPANIC OR LATINO ORIGIN OF HOUSEHOLDER!!)|(RACE!!))+", ""))) %>%
#   rename(County = "Geographic Area Name")%>%
#   mutate(County = sub(" County, Wisconsin", "", County))
# 
# #Library Data
# library_data <- readxl::read_excel("data\\public_library_service_data_2019.xlsx", sheet = "2019 PRELIMINARY DATA", skip = 1) %>%
#   slice(-1) %>%
#   select(-c("Library ID", "Branches", "15. No. of Bookmobiles Owned", 
#             "Other Service Outlets", "Books-by-Mail", "Joint Library under s.43.53 1=Yes", 
#             "Circulation Count Method: Actual / Survey", "Locale Code"), 
#          -matches("Outlay"), -matches("Access Denied"), -matches("Databases")) 
# data <- library_data %>%
#   left_join(demo_2019, by="County") %>%
#   inner_join(income_2019, by="County") 
# 
# #Cleaned the data a bit, excluded all but our 8 target counties (please LMK if you don't like this approach). Chose 17 features that I thought looked interesting and renamed them.
# counties_here = data%>%
#   group_by(County)%>%
#   drop_na(`Households!!One race--!!Black or African American`)%>%
#   summarize(first(County))
# 
# counties = counties_here$County
# 
# spec_data = data%>%
#   filter(County %in% counties)%>%
#   select(`Public Library`, 
#          County, 
#          `Number of Public Use Computers`, 
#          `Library Visits`, 
#          `Total Number of Programs`, 
#          `Total Income`, 
#          `Uses of Public Internet Computers`, 
#          `RACE!!Total population`, 
#          `Households!!One race--!!Black or African American`, 
#          `Households!!One race--!!Asian`, 
#          `Households!!One race--!!White`, 
#          `HISPANIC OR LATINO AND RACE!!Total population`, 
#          `Median income (dollars)!!Households`, 
#          `Median income (dollars)!!Households!!One race--!!Black or African American`, 
#          `Median income (dollars)!!Households!!One race--!!Asian`, 
#          `Median income (dollars)!!Households!!Hispanic or Latino origin (of any race)`, 
#          `Median income (dollars)!!Households!!White alone, not Hispanic or Latino`) %>%
#   rename(library = `Public Library`,
#          number_computers = `Number of Public Use Computers`,
#          library_visits = `Library Visits`,
#          number_programs = `Total Number of Programs`,
#          funding = `Total Income`,
#          computer_usage = `Uses of Public Internet Computers`,
#          pop_black = `Households!!One race--!!Black or African American`,
#          pop_asian = `Households!!One race--!!Asian`,
#          pop_white = `Households!!One race--!!White`,
#          pop_hispanic = `HISPANIC OR LATINO AND RACE!!Total population`,
#          med_income_agg = `Median income (dollars)!!Households`,
#          med_income_black = `Median income (dollars)!!Households!!One race--!!Black or African American`,
#          med_income_asian = `Median income (dollars)!!Households!!One race--!!Asian`,
#          med_income_hisp = `Median income (dollars)!!Households!!Hispanic or Latino origin (of any race)`,
#          med_income_white =`Median income (dollars)!!Households!!White alone, not Hispanic or Latino`)
#          
#          
# spec_data[,3:17] = sapply(spec_data[,3:17],as.numeric)
# 
# spec_data 
```

```{r, echo=FALSE}
# library_data %>%
#   left_join(demo_2019, by="County") %>% 
#   group_by(County) %>%
#   summarise(count = n())
# 
# library_data %>%
#   inner_join(income_2019, by="County") %>% 
#   group_by(County) %>%
#   summarise(count = n())
# 
# library_data %>% 
#   left_join(demo_2019, by="County") %>% 
#   inner_join(income_2019, by="County") %>% 
#   group_by(County) %>%
#   mutate(count = n()) 
```